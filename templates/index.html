{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internship Recommender</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Find Your Internship</h1>

        <div class="form-group">
            <label for="skillSelect">Select Your Key Skills</label>
            <div style="display: flex; gap: 10px;">
                <select id="skillSelect">
                    <option value="Python">Python</option>
                    <option value="JavaScript">JavaScript</option>
                    <option value="React">React</option>
                    <option value="MongoDB">MongoDB</option>
                    <option value="SQL">SQL</option>
                    <option value="Data Analysis">Data Analysis</option>
                    <option value="Machine Learning">Machine Learning</option>
                    <option value="Video Editing">Video Editing</option>
                </select>
                <button class="secondary" onclick="addSkill()" style="width: 120px;">Add</button>
            </div>
        </div>

        <div class="form-group">
            <label>Selected Skills:</label>
            <div id="selectedSkills"></div>
        </div>

        <div class="form-group">
            <label for="interestInput">Describe the type of internship you want</label>
            <textarea id="interestInput" rows="3" placeholder="e.g., I want to work on building user interfaces for a fintech company."></textarea>
        </div>

        <div class="form-group">
            <label for="locationSelect">Select a Location</label>
            <select id="locationSelect">
                <option value="">--Please choose a location--</option>
                <option value="Pune">Pune</option>
                <option value="Mumbai">Mumbai</option>
                <option value="Bangalore">Bangalore</option>
                <option value="Chennai">Chennai</option>
                <option value="Work from home">Work from home</option>
            </select>
        </div>

        <button onclick="getRecommendations()">Find Internships</button>
        <div id="results"><p>Results will appear here...</p></div>
    </div>
    <div id="analyticsModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <div id="modalBody"></div>
    </div>
</div>
    <script>
        const selectedSkills = new Set();

        function addSkill() {
            const skillSelect = document.getElementById('skillSelect');
            const skill = skillSelect.value;
            if (skill && !selectedSkills.has(skill)) {
                selectedSkills.add(skill);
                updateSelectedSkillsDisplay();
            }
        }

        function removeSkill(skill) {
            selectedSkills.delete(skill);
            updateSelectedSkillsDisplay();
        }

        function updateSelectedSkillsDisplay() {
            const displayDiv = document.getElementById('selectedSkills');
            displayDiv.innerHTML = '';
            selectedSkills.forEach(skill => {
                displayDiv.innerHTML += `
                    <span class="skill-tag">
                        ${skill}
                        <span class="remove-skill" onclick="removeSkill('${skill}')">&times;</span>
                    </span>
                `;
            });
        }

        async function getRecommendations() {
            const interest = document.getElementById('interestInput').value;
            const location = document.getElementById('locationSelect').value;
            const resultsDiv = document.getElementById('results');

            // Get skills from the Set, not a text box
            const skillsString = Array.from(selectedSkills).join(',');

            if (!skillsString || !location) {
                resultsDiv.innerHTML = '<p>Please select at least one skill and a location.</p>';
                return;
            }

            resultsDiv.innerHTML = '<p>Loading...</p>';

            const apiUrl = `/api/recommend/?skills=${encodeURIComponent(skillsString)}&location=${encodeURIComponent(location)}&interest=${encodeURIComponent(interest)}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                resultsDiv.innerHTML = '';

                if (data.recommendations && data.recommendations.length > 0) {
                    resultsDiv.innerHTML += `<h3>${data.message}</h3>`;
                    data.recommendations.forEach(rec => {
                        const internship = rec.internship;
                        resultsDiv.innerHTML += `
                            <div class="internship-card">
                                <h4>${internship.Title}</h4>
                                <p><strong>Location:</strong> ${internship.Locations}</p>
                                <p><strong>Description:</strong> ${internship.Description}</p>
                                <p><strong>Skills:</strong> ${internship.Skills}</p>
                                <p><strong>Score:</strong> ${rec.final_score.toFixed(4)}</p>
                                <button class="analytics-btn" onclick="getAnalytics('${internship.id}')">Why & How?</button>
                            </div>
                        `;
                    });
                } else {
                    resultsDiv.innerHTML = `<p>${data.message || 'No recommendations found.'}</p>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = '<p>An error occurred while fetching recommendations.</p>';
                console.error('Error:', error);
            }
        }
        async function getAnalytics(internshipId) {
        const skillsString = Array.from(selectedSkills).join(',');
        const modalBody = document.getElementById('modalBody');
        const modal = document.getElementById('analyticsModal');

        modal.style.display = 'block'; // Show the modal
        modalBody.innerHTML = '<p>Generating your learning plan...</p>';

        const apiUrl = `/api/analytics/?id=${internshipId}&skills=${encodeURIComponent(skillsString)}`;
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data.error) {
            modalBody.innerHTML = `<p>Error: ${data.error}</p>`;
            return;
        }

        // Build the HTML for the analytics
        let content = `<h2>Learning Plan</h2>`;
        content += `<h4>Why it was recommended:</h4><p>${data.explanation}</p>`;

        data.lacking_skills_roadmap.forEach(roadmap => {
            content += `<hr><h3>Roadmap for: ${roadmap.skill_name}</h3>`;

            content += '<h4>Milestones:</h4><ul>';
            roadmap.learning_roadmap.milestones.forEach(m => { content += `<li>${m}</li>`; });
            content += '</ul>';

            content += '<h4>Mini Projects:</h4><ul>';
            roadmap.learning_roadmap.mini_projects.forEach(p => { content += `<li>${p}</li>`; });
            content += '</ul>';

            content += '<h4>Resources:</h4>';
            content += '<h5>Courses:</h5><ul>';
            roadmap.learning_roadmap.resources.online_courses.forEach(c => {
                content += `<li><a href="${c.url}" target="_blank">${c.name}</a></li>`;
            });
            content += '</ul>';

            content += '<h5>YouTube Playlists:</h5><ul>';
            roadmap.learning_roadmap.resources.youtube_playlists.forEach(v => {
                content += `<li><a href="${v.url}" target="_blank">${v.title}</a></li>`;
            });
            content += '</ul>';

            content += `<h5><a href="${roadmap.learning_roadmap.resources.official_docs}" target="_blank">Official Documentation</a></h5>`;
        });

        modalBody.innerHTML = content;
    }

    function closeModal() {
        document.getElementById('analyticsModal').style.display = 'none';
    }
    </script>
</body>
</html>